<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Print Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-right: 20px;
        }
        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .mode-btn:hover,
        .mode-btn.active {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        .search-box {
            flex: 1;
            max-width: 400px;
            margin-right: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .search-box input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .category-filter {
            display: flex;
            gap: 10px;
        }
        .category-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-btn:hover,
        .category-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .admin-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .admin-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* Shipping Label Mode Styles */
        .shipping-mode {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .shipping-mode.active {
            display: block;
        }
        .shipping-search {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }
        .tracking-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
        }
        .tracking-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .lookup-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .lookup-btn:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        .lookup-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .label-preview {
            display: none;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }
        .label-preview.show {
            display: block;
        }
        .label-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-group h4 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-group p {
            color: #212529;
            font-size: 16px;
            font-weight: 500;
        }
        .label-image {
            text-align: center;
            margin-bottom: 20px;
        }
        .label-image iframe {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .print-shipping {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        .shipping-quantity {
            width: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }
        .shipping-quantity:focus {
            outline: none;
            border-color: #28a745;
        }
        .print-shipping-btn {
            padding: 12px 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .print-shipping-btn:hover {
            background: linear-gradient(45deg, #218838, #1aa085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        .print-shipping-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Product Mode Styles (existing) */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .products-grid.hidden {
            display: none;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        .product-image {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .product-image.no-image {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            color: #6c757d;
            font-size: 48px;
        }
        .product-info h3 {
            font-size: 1.3em;
            margin-bottom: 8px;
            color: #333;
        }
        .product-info p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #777;
        }
        .category-tag {
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        .print-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .quantity-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }
        .quantity-input:focus {
            outline: none;
            border-color: #28a745;
        }
        .print-button {
            flex: 1;
            padding: 12px 24px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .print-button:hover {
            background: linear-gradient(45deg, #218838, #1aa085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        .print-button:active {
            transform: translateY(0);
        }
        .print-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }
        .error-message {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .success-message {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .no-products {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
            display: none;
        }
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            .search-box {
                margin-right: 0;
                max-width: 100%;
            }
            .products-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .mode-toggle {
                margin-right: 0;
                margin-bottom: 10px;
            }
            .label-info {
                grid-template-columns: 1fr;
            }
            .shipping-search {
                flex-direction: column;
            }
        }

        .scan-btn {
    padding: 15px 20px;
    background: linear-gradient(45deg, #6f42c1, #5a2d91);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: 10px;
}
.scan-btn:hover {
    background: linear-gradient(45deg, #5a2d91, #4c1d82);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(111, 66, 193, 0.3);
}
.scan-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.shipping-search {
    flex-direction: column;
    gap: 10px; /* Reduce gap on mobile */
}
.scan-btn {
    padding: 12px 16px; /* Slightly smaller on mobile */
    margin-right: 0;
    margin-bottom: 5px;
}

#scannerContainer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: black;
    z-index: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

#scannerContainer video,
#scannerContainer canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    border: none;
    border-radius: 0;
}

/* full-screen black background */
#scannerOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: black;
    z-index: 9999;
}

/* make the container fill the overlay */
#scannerOverlay #scannerContainer {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    overflow: hidden;
}

/* video AND canvas fill the container */
#scannerOverlay video,
#scannerOverlay canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
}

/* clean reticle with dark overlay */
#scannerOverlay .reticle {
    position: absolute;
    top: 50%; left: 50%;
    width: 280px; height: 120px;
    margin: -60px 0 0 -140px;
    border: 2px solid #00ff00;
    border-radius: 12px;
    pointer-events: none;
    z-index: 2;
    box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.5);
}

/* single horizontal scan line */
#scannerOverlay .reticle::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 75%; height: 2px;
    background: #ff0000;
    transform: translate(-50%, -50%);
    border-radius: 1px;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
}

/* simple close button */
#scannerOverlay .close-btn {
    position: absolute;
    top: 20px; right: 20px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    font-size: 1.2em;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 3;
}

    </style>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.5/dist/quagga.min.js"></script>

</head>
<body>
    <div class="header">
        <h1>🏭 Warehouse Print Center</h1>
        <p id="headerDescription">Click to print labels and documents</p>
    </div>
    
    <div class="controls">
        <div class="mode-toggle">
            <button class="mode-btn active" id="productModeBtn" onclick="switchMode('product')">
                📦 Products
            </button>
            <button class="mode-btn" id="shippingModeBtn" onclick="switchMode('shipping')">
                🚚 Shipping Labels
            </button>
            <button class="mode-btn" id="pdfSignerModeBtn" onclick="switchMode('pdfsigner')">
    ✍️ PDF Signer
</button>
<a href="/unverified" class="category-btn">verified login</a>
        </div>
        
        <div class="search-box" id="productSearch">
            <input type="text" id="searchInput" placeholder="🔍 Search products...">
        </div>
        
        <div class="category-filter" id="categoryFilter">
            <button class="category-btn active" data-category="all">All</button>
        </div>
        <a href="/ops/whats-this" class="category-btn">⚙️ what's this?</a>
        
        <a href="/ops/admin" class="admin-link">⚙️ Admin</a>
    </div>
    
    <!-- Shipping Label Mode -->
    <div class="shipping-mode" id="shippingMode">
        <h2 style="margin-bottom: 20px; color: #333;">📦 Shipping Label Lookup</h2>
        
<div class="shipping-search">
    <input type="text" 
           class="tracking-input" 
           id="trackingInput" 
           placeholder="Enter tracking number (e.g., 1ZHY49120300197340)"
           onkeypress="handleTrackingKeypress(event)">
    <button class="scan-btn" id="scanBtn" onclick="scanBarcode()">
        📷 Scan
    </button>
    <button class="lookup-btn" id="lookupBtn" onclick="lookupShippingLabel()">
        🔍 Lookup
    </button>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraResult(event)">
</div>
        
        <div class="label-preview" id="labelPreview">
            <div class="label-info" id="labelInfo">
                <!-- Label information will be populated here -->
            </div>
            
            <div class="label-image" id="labelImage">
                <!-- PDF preview will be displayed here -->
            </div>
            
            <div class="print-shipping">
                <input type="number" class="shipping-quantity" id="shippingQuantity" value="1" min="1" max="99">
                <button class="print-shipping-btn" id="printShippingBtn" onclick="printShippingLabel()">
                    🖨️ Print Shipping Label
                </button>
            </div>
        </div>
    </div>

    <!-- PDF Signer Mode -->
<div class="shipping-mode" id="pdfSignerMode">
<h2 style="margin-bottom: 20px; color: #333;">✍️ PDF Document Signer</h2>
<p style="margin-bottom: 20px; color: #666; font-style: italic; text-align: center;">Automatically adds signature to OP-900 Laser File (red sticker paper for hazmats)</p>    
    <div class="shipping-search">
        <div id="dropZone" style="border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
            <p style="margin: 0; font-size: 18px; color: #666;">📄 Drag & drop a PDF here or click to select</p>
            <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
        </div>
    </div>
    
    <div class="label-preview" id="pdfPreview">
        <div style="text-align: center; margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">Selected PDF:</h4>
            <p id="selectedFileName" style="font-weight: 500; color: #007bff;"></p>
        </div>
        
        <div class="print-shipping">
            <button class="print-shipping-btn" id="signPdfBtn" onclick="signAndDownloadPdf()">
                ✍️ Sign & Download PDF
            </button>
        </div>
    </div>
</div>
    
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
    <div class="loading" id="loading">Loading products...</div>
    <div class="no-products" id="noProducts">No products found</div>
    <div class="products-grid" id="productsGrid"></div>

    <script>
        let allProducts = [];
        let currentCategory = 'all';
        let currentMode = 'product';
        let currentLabel = null;

        // Load products on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterProducts();
            });

            // Category filter functionality
            document.getElementById('categoryFilter').addEventListener('click', function(e) {
                if (e.target.classList.contains('category-btn')) {
                    // Update active category button
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    currentCategory = e.target.dataset.category;
                    filterProducts();
                }
            });
        }

function switchMode(mode) {
    currentMode = mode;
    
    // Update button states
    document.getElementById('productModeBtn').classList.toggle('active', mode === 'product');
    document.getElementById('shippingModeBtn').classList.toggle('active', mode === 'shipping');
    document.getElementById('pdfSignerModeBtn').classList.toggle('active', mode === 'pdfsigner');
    
    // Update header
    const headerDesc = document.getElementById('headerDescription');
    
    if (mode === 'product') {
        // Show product interface
        document.getElementById('productSearch').style.display = 'block';
        document.getElementById('categoryFilter').style.display = 'flex';
        document.getElementById('productsGrid').classList.remove('hidden');
        document.getElementById('shippingMode').classList.remove('active');
        document.getElementById('pdfSignerMode').classList.remove('active');
        document.getElementById('noProducts').style.display = allProducts.length === 0 ? 'block' : 'none';
        headerDesc.textContent = 'Click to print labels and documents';
    } else if (mode === 'shipping') {
        // Show shipping interface
        document.getElementById('productSearch').style.display = 'none';
        document.getElementById('categoryFilter').style.display = 'none';
        document.getElementById('productsGrid').classList.add('hidden');
        document.getElementById('shippingMode').classList.add('active');
        document.getElementById('pdfSignerMode').classList.remove('active');
        document.getElementById('noProducts').style.display = 'none';
        headerDesc.textContent = 'Enter tracking number to lookup and print shipping labels';
        
        // Focus on tracking input
        setTimeout(() => {
            document.getElementById('trackingInput').focus();
        }, 100);
    } else if (mode === 'pdfsigner') {
        // Show PDF signer interface
        document.getElementById('productSearch').style.display = 'none';
        document.getElementById('categoryFilter').style.display = 'none';
        document.getElementById('productsGrid').classList.add('hidden');
        document.getElementById('shippingMode').classList.remove('active');
        document.getElementById('pdfSignerMode').classList.add('active');
        document.getElementById('noProducts').style.display = 'none';
        headerDesc.textContent = 'Upload PDF documents to add signature';
        
        setupPdfSigner();
    }
}

        function handleTrackingKeypress(event) {
            if (event.key === 'Enter') {
                lookupShippingLabel();
            }
        }

        async function lookupShippingLabel() {
            const trackingInput = document.getElementById('trackingInput');
            const lookupBtn = document.getElementById('lookupBtn');
            const labelPreview = document.getElementById('labelPreview');
            
            const trackingNumber = trackingInput.value.trim();
            
            if (!trackingNumber) {
                showError('Please enter a tracking number');
                return;
            }
            
            try {
                // Update button state
                lookupBtn.disabled = true;
                lookupBtn.innerHTML = '🔄 Looking up...';
                
                // Hide previous preview
                labelPreview.classList.remove('show');
                
                const response = await fetch(`/api/shipping-label/${encodeURIComponent(trackingNumber)}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentLabel = result.label;
                    displayLabelPreview(result.label);
                    showSuccess(`✅ Label found for tracking number: ${trackingNumber}`);
                } else {
                    showError(`❌ ${result.error || 'Label not found'}`);
                    currentLabel = null;
                }
            } catch (error) {
                showError('❌ Lookup failed: ' + error.message);
                currentLabel = null;
            } finally {
                lookupBtn.disabled = false;
                lookupBtn.innerHTML = '🔍 Lookup';
            }
        }

        function displayLabelPreview(label) {
            const labelInfo = document.getElementById('labelInfo');
            const labelImage = document.getElementById('labelImage');
            const labelPreview = document.getElementById('labelPreview');
            
            // Format ship date
            const shipDate = label.ship_date ? new Date(label.ship_date).toLocaleDateString() : 'N/A';
            
            // Populate label information
            labelInfo.innerHTML = `
                <div class="info-group">
                    <h4>Tracking Number</h4>
                    <p>${label.tracking_number || 'N/A'}</p>
                </div>
                <div class="info-group">
                    <h4>Carrier</h4>
                    <p>${(label.carrier_code || '').toUpperCase()} ${label.service_code || ''}</p>
                </div>
                <div class="info-group">
                    <h4>Status</h4>
                    <p style="color: ${label.status === 'completed' ? '#28a745' : '#ffc107'}">
                        ${(label.status || 'Unknown').charAt(0).toUpperCase() + (label.status || 'Unknown').slice(1)}
                    </p>
                </div>
                <div class="info-group">
                    <h4>Ship Date</h4>
                    <p>${shipDate}</p>
                </div>
                <div class="info-group">
                    <h4>Ship To</h4>
                    <p>${label.ship_to?.name || 'N/A'}</p>
                </div>
                <div class="info-group">
                    <h4>Address</h4>
                    <p>${label.ship_to?.city_locality || ''}, ${label.ship_to?.state_province || ''}</p>
                </div>
            `;
            
            // Display PDF preview
            if (label.pdf_url) {
                labelImage.innerHTML = `
                    <iframe src="${label.pdf_url}" 
                            width="400" 
                            height="300" 
                            style="max-width: 100%;">
                    </iframe>
                `;
            } else {
                labelImage.innerHTML = '<p style="color: #666;">No preview available</p>';
            }
            
            // Show the preview
            labelPreview.classList.add('show');
        }

        async function printShippingLabel() {
            if (!currentLabel) {
                showError('No label selected for printing');
                return;
            }
            
            const printBtn = document.getElementById('printShippingBtn');
            const quantityInput = document.getElementById('shippingQuantity');
            const quantity = parseInt(quantityInput.value) || 1;
            
            const originalText = printBtn.innerHTML;
            
            try {
                printBtn.disabled = true;
                printBtn.innerHTML = '🔄 Printing...';
                
                const response = await fetch('/api/print-shipping-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pdf_url: currentLabel.pdf_url,
                        tracking_number: currentLabel.tracking_number,
                        quantity: quantity
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`✅ ${result.message}`);
                    printBtn.innerHTML = '✅ Printed!';
                    
                    setTimeout(() => {
                        printBtn.disabled = false;
                        printBtn.innerHTML = originalText;
                    }, 3000);
                } else {
                    showError(`❌ ${result.error}`);
                    printBtn.disabled = false;
                    printBtn.innerHTML = originalText;
                }
            } catch (error) {
                showError('❌ Print failed: ' + error.message);
                printBtn.disabled = false;
                printBtn.innerHTML = originalText;
            }
        }

        async function loadProducts() {
            try {
                showLoading(true);
                const response = await fetch('/api/products');
                const products = await response.json();
                
                if (response.ok) {
                    allProducts = products;
                    setupCategories();
                    displayProducts(products);
                } else {
                    showError('Failed to load products');
                }
            } catch (error) {
                showError('Error loading products: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function setupCategories() {
            const categories = [...new Set(allProducts.map(p => p.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Keep the "All" button and add category buttons
            const allButton = categoryFilter.querySelector('[data-category="all"]');
            categoryFilter.innerHTML = '';
            categoryFilter.appendChild(allButton);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.dataset.category = category;
                button.textContent = category;
                categoryFilter.appendChild(button);
            });
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allProducts;
            
            // Filter by category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(p => p.category === currentCategory);
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.description.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm)
                );
            }
            
            displayProducts(filtered);
        }

        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            const noProducts = document.getElementById('noProducts');
            
            if (products.length === 0 && currentMode === 'product') {
                grid.style.display = 'none';
                noProducts.style.display = 'block';
                return;
            }
            
            if (currentMode === 'product') {
                grid.style.display = 'grid';
                noProducts.style.display = 'none';
            }
            
grid.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="status-indicator" title="Ready to print"></div>
                    <div class="product-image ${product.image ? '' : 'no-image'}">
                        ${product.image ? 
                            `<img src="/static/images/${product.image}" alt="${product.name}" onerror="this.parentElement.innerHTML='📄'">` : 
                            '📄'
                        }
                    </div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p>${product.description || 'No description available'}</p>
                        <div class="product-meta">
                            <span class="category-tag">${product.category}</span>
                            <span class="printer-tag" title="Printer: ${
                                product.printer_id === '74471601' ? 'Epson' :
                                product.printer_id === '74471602' ? 'Zebra' :
                                'Unknown'
                            }">
                                🖨️ ${
                                    product.printer_id === 74471601 ? 'Epson' :
                                    product.printer_id === 74471602 ? 'Zebra' :
                                    'Unknown'
                                }
                            </span>
                            ${product.paper_size ? 
                                `<span class="paper-tag" title="Paper Size: ${product.paper_size}">📄 ${product.paper_size}</span>` : 
                                '<span class="paper-tag default" title="Uses printer default paper size">📄 Default</span>'
                            }
                        </div>
                        <div class="print-section">
                            <input type="number" class="quantity-input" value="1" min="1" max="99" id="qty-${product.id}">
                            <button class="print-button" onclick="printProduct('${product.id}', this)">
                                🖨️ Print
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function printProduct(productId, button) {
            const originalText = button.innerHTML;
            const quantityInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            try {
                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = '🔄 Printing...';
                
                const response = await fetch(`/api/print/${productId}?quantity=${quantity}`);
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(`✅ ${result.message}`);
                    button.innerHTML = '✅ Printed!';
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 3000);
                } else {
                    showError(`❌ ${result.error}`);
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            } catch (error) {
                showError('❌ Print failed: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            if (currentMode === 'product') {
                document.getElementById('productsGrid').style.display = show ? 'none' : 'grid';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Auto-refresh products every 30 seconds (only in product mode)
        setInterval(() => {
            if (currentMode === 'product') {
                loadProducts();
            }
        }, 30000);


        let selectedPdfFile = null;

function setupPdfSigner() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('pdfFileInput');
    
    // Click to select file
    dropZone.addEventListener('click', () => fileInput.click());
    
    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#007bff';
        dropZone.style.backgroundColor = '#e3f2fd';
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.backgroundColor = '#f8f9fa';
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.backgroundColor = '#f8f9fa';
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            handlePdfSelection(files[0]);
        } else {
            showError('Please select a PDF file');
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handlePdfSelection(e.target.files[0]);
        }
    });
}

function handlePdfSelection(file) {
    selectedPdfFile = file;
    document.getElementById('selectedFileName').textContent = file.name;
    document.getElementById('pdfPreview').classList.add('show');
    showSuccess(`PDF selected: ${file.name}`);
}

async function signAndDownloadPdf() {
    if (!selectedPdfFile) {
        showError('Please select a PDF file first');
        return;
    }
    
    const signBtn = document.getElementById('signPdfBtn');
    const originalText = signBtn.innerHTML;
    
    try {
        signBtn.disabled = true;
        signBtn.innerHTML = '🔄 Signing PDF...';
        
        const formData = new FormData();
        formData.append('file', selectedPdfFile);
        
        const response = await fetch('/api/sign-pdf', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `signed_${selectedPdfFile.name}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            showSuccess('✅ PDF signed and downloaded successfully!');
            signBtn.innerHTML = '✅ Signed!';
            
            setTimeout(() => {
                signBtn.disabled = false;
                signBtn.innerHTML = originalText;
            }, 3000);
        } else {
            const error = await response.json();
            showError(`❌ ${error.error || 'Failed to sign PDF'}`);
            signBtn.disabled = false;
            signBtn.innerHTML = originalText;
        }
    } catch (error) {
        showError('❌ Sign failed: ' + error.message);
        signBtn.disabled = false;
        signBtn.innerHTML = originalText;
    }
}

function scanBarcode() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        startLiveBarcodeScanner();
    } else {
        document.getElementById('cameraInput').click();
    }
}


function startLiveBarcodeScanner() {
    const scanBtn = document.getElementById('scanBtn');
    scanBtn.innerHTML = '📸 Starting Camera...';
    scanBtn.disabled = true;

    const scannerOverlay = createScannerOverlay();
    document.body.appendChild(scannerOverlay);

    const scannerContainer = scannerOverlay.querySelector('#scannerContainer');
    if (!scannerContainer) {
        showError("Camera error: Scanner container not found");
        scanBtn.innerHTML = '📷 Scan';
        scanBtn.disabled = false;
        document.body.removeChild(scannerOverlay);
        return;
    }

    // ensure the overlay is fully rendered before initializing Quagga
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        facingMode: "environment",
                        width:  { min: 640 },
                        height: { min: 480 }
                    }
                },
                locator: { patchSize: "medium", halfSample: true },
                numOfWorkers: 2,
                decoder: { readers: ["code_128_reader"] },
                locate: true
            }, function(err) {
                if (err) {
                    showError("Camera error: " + err.message);
                    scanBtn.innerHTML = '📷 Scan';
                    scanBtn.disabled = false;
                    document.body.removeChild(scannerOverlay);
                    return;
                }
                Quagga.start();
                scanBtn.innerHTML = '📱 Point at barcode';
                Quagga.onDetected(result => {
                    const code = result.codeResult.code;
                    
                    // Filter out invalid barcodes
                    if (code && isValidBarcode(code)) {
                        // For 34-digit codes, use only the last 12 digits
                        const finalCode = (code.length === 34 && /^\d+$/.test(code)) 
                            ? code.slice(-12) 
                            : code;
                        
                        document.getElementById("trackingInput").value = finalCode;
                        showSuccess("✅ Scanned: " + finalCode);
                        Quagga.stop();
                        closeBarcodeScanner();
                        lookupShippingLabel();
                    }
                    // Invalid barcodes are ignored silently
                });
            });
        });
    });

    window.closeBarcodeScanner = () => {
        Quagga.stop();
        document.body.removeChild(scannerOverlay);
        scanBtn.innerHTML = '📷 Scan';
        scanBtn.disabled = false;
    };
}

function isValidBarcode(code) {
    // Check if starts with specific prefixes
    if (code.startsWith("1ZHY4912") || code.startsWith("1ZH965")) {
        return true;
    }
    
    // Check if it's exactly 34 digits, only numeric
    if (code.length === 34 && /^\d+$/.test(code)) {
        return true;
    }
    
    return false;
}

function createScannerOverlay() {
  const overlay = document.createElement('div');
  overlay.id = 'scannerOverlay';
  overlay.innerHTML = `
    <button class="close-btn" onclick="closeBarcodeScanner()">✕</button>
    <div id="scannerContainer"></div>
    <div class="reticle"></div>
  `;
  return overlay;
}


// Function to handle manual input
window.useManualInput = function() {
    const manualInput = document.getElementById('manualTrackingInput');
    const trackingInput = document.getElementById('trackingInput');
    
    if (manualInput.value.trim()) {
        trackingInput.value = manualInput.value.trim();
        closeBarcodeScanner();
        showSuccess('✅ Tracking number entered manually');
        // Auto-trigger lookup
        setTimeout(() => {
            lookupShippingLabel();
        }, 500);
    }
};

function handleCameraResult(event) {
    // Keep this for the file input fallback
    const scanBtn = document.getElementById('scanBtn');
    scanBtn.innerHTML = '📷 Scan';
    scanBtn.disabled = false;
    
    if (event.target.files && event.target.files[0]) {
        showSuccess('📸 Image captured. Look for barcode detection popup from Safari.');
    }
    
    event.target.value = '';
}

    </script>
</body>
</html>